<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CivicRevolution - Login/Register</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #2c8ef4, #14cba8);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .auth-container {
      background: #fff;
      width: 90%;
      max-width: 420px;
      padding: 2rem;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
      color: #2563eb;
    }

    input {
      width: 100%;
      padding: 0.9rem;
      margin: 0.6rem 0;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 1rem;
    }

    button {
      width: 100%;
      padding: 0.9rem;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      cursor: pointer;
      margin-top: 0.5rem;
      transition: 0.3s;
    }

    button:hover {
      background: #1e4ed8;
    }

    .switch-auth {
      text-align: center;
      margin-top: 1rem;
      font-size: 0.95rem;
    }

    .switch-auth span {
      color: #2563eb;
      cursor: pointer;
      font-weight: bold;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div class="auth-container">
    <div id="loginForm">
      <h1>Login</h1>
      <input type="text" id="loginUsername" placeholder="Username" />
      <input type="password" id="loginPassword" placeholder="Password" />
      <button id="loginBtn">Login</button>
      <p id="loginError" style="color:red; font-size:0.9rem; display:none;">❌ Invalid username or password.</p>
      <p class="switch-auth">Don’t have an account? <span id="registerSwitch">Register</span></p>
    </div>

    <div id="registerForm" class="hidden">
      <h1>Register</h1>
      <input type="text" id="regUsername" placeholder="Full Name" />
      <input type="password" id="regPassword" placeholder="Password" />
      <input type="text" id="regAadhaar" placeholder="Aadhaar Number" maxlength="12" />
      <input type="text" id="regPhone" placeholder="Phone Number" maxlength="10" />
      <button id="registerBtn">Register</button>
      <p id="registerError" style="color:red; font-size:0.9rem; display:none;">⚠ Fill all fields correctly</p>
      <p class="switch-auth">Already have an account? <span id="loginSwitch">Login</span></p>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    const SUPABASE_URL = 'https://xnqtjcovuqzajuqzaunf.supabase.co'
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_KEY'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    function showRegister() {
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("registerForm").classList.remove("hidden");
      document.getElementById("loginError").style.display = "none";
      document.getElementById("registerError").style.display = "none";
    }
    function showLogin() {
      document.getElementById("registerForm").classList.add("hidden");
      document.getElementById("loginForm").classList.remove("hidden");
      document.getElementById("loginError").style.display = "none";
      document.getElementById("registerError").style.display = "none";
    }

    async function register() {
      const user = document.getElementById("regUsername").value.trim();
      const pass = document.getElementById("regPassword").value.trim();
      const aadhaar = document.getElementById("regAadhaar").value.trim();
      const phone = document.getElementById("regPhone").value.trim();

      if (!user || !pass || !aadhaar || !phone) {
        document.getElementById("registerError").innerText = "⚠ All fields are required.";
        document.getElementById("registerError").style.display = "block";
        return;
      }
      if (!/^\d{12}$/.test(aadhaar)) {
        document.getElementById("registerError").innerText = "⚠ Aadhaar must be 12 digits.";
        document.getElementById("registerError").style.display = "block";
        return;
      }
      if (!/^\d{10}$/.test(phone)) {
        document.getElementById("registerError").innerText = "⚠ Phone number must be 10 digits.";
        document.getElementById("registerError").style.display = "block";
        return;
      }

      try {
        // ✅ Check Aadhaar already exists
        const { data: aadhaarExists } = await supabase
          .from("registrations")
          .select("id")
          .eq("aadhaar", aadhaar)
          .maybeSingle();

        if (aadhaarExists) {
          document.getElementById("registerError").innerText = "⚠ Aadhaar is already registered.";
          document.getElementById("registerError").style.display = "block";
          return;
        }

        // ✅ Check Phone already exists
        const { data: phoneExists } = await supabase
          .from("registrations")
          .select("id")
          .eq("phone", phone)
          .maybeSingle();

        if (phoneExists) {
          document.getElementById("registerError").innerText = "⚠ Phone number is already registered.";
          document.getElementById("registerError").style.display = "block";
          return;
        }

        // Step 1: Ask Supabase Edge Function to send OTP
        const response = await fetch("https://xnqtjcovuqzajuqzaunf.functions.supabase.co/send-otp", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({ phone: phone })
        });

        const result = await response.json();

        if (result.success) {
          alert("✅ OTP sent! Please verify.");
          // Step 2: Redirect to OTP page with details
          window.location.href = `otp.html?username=${encodeURIComponent(user)}&password=${encodeURIComponent(pass)}&aadhaar=${encodeURIComponent(aadhaar)}&phone=${encodeURIComponent(phone)}`;
        } else {
          document.getElementById("registerError").innerText = "⚠ Failed to send OTP.";
          document.getElementById("registerError").style.display = "block";
        }

      } catch (error) {
        console.error(error);
        document.getElementById("registerError").innerText = "⚠ Something went wrong.";
        document.getElementById("registerError").style.display = "block";
      }
    }

    async function login() {
      const user = document.getElementById("loginUsername").value.trim();
      const pass = document.getElementById("loginPassword").value.trim();
      const { data, error } = await supabase.from('registrations').select('*').eq('username', user).eq('password', pass);
      if (error) { document.getElementById("loginError").innerText = "❌ Error reading database."; document.getElementById("loginError").style.display = "block"; return; }
      if (data && data.length > 0) { localStorage.setItem("loggedIn", "true"); window.location.href = "home.html"; }
      else { document.getElementById("loginError").innerText = "❌ Invalid username or password."; document.getElementById("loginError").style.display = "block"; }
    }

    document.getElementById("registerSwitch").onclick = showRegister;
    document.getElementById("loginSwitch").onclick = showLogin;
    document.getElementById("registerBtn").onclick = register;
    document.getElementById("loginBtn").onclick = login;
  </script>
</body>

</html>
