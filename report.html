<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  const SUPABASE_URL = 'https://xnqtjcovuqzajuqzaunf.supabase.co'
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhucXRqY292dXF6YWp1cXphdW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MzIyMzEsImV4cCI6MjA3MzEwODIzMX0.YbmzZoqOdIX_inX-khtpg1IsiCNUROAvR4Z2N85lEvM'
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

  const bucketName = 'Complaint-Images'

  // Map
  let map, marker
  function initMap() {
    map = L.map('map').setView([18.5204, 73.8567], 12)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map)
    map.on('click', (e) => {
      const lat = e.latlng.lat
      const lng = e.latlng.lng
      document.getElementById('latitude').value = lat
      document.getElementById('longitude').value = lng
      if (marker) map.removeLayer(marker)
      marker = L.marker([lat, lng]).addTo(map)
    })
  }
  window.addEventListener('load', initMap)

  // Geolocation
  document.getElementById('useLocBtn').onclick = function () {
    if (!navigator.geolocation) { alert('Geolocation not supported'); return }
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude
        const lng = pos.coords.longitude
        document.getElementById('latitude').value = lat
        document.getElementById('longitude').value = lng
        map.setView([lat, lng], 15)
        if (marker) map.removeLayer(marker)
        marker = L.marker([lat, lng]).addTo(map)
      },
      (err) => alert('Location error: ' + err.message)
    )
  }

  // Upload image
  async function uploadImage(file) {
    if (!file) return null
    const ext = file.name.split('.').pop()
    const path = ${Date.now()}.${ext}
    const { error: upErr } = await supabase.storage.from(bucketName).upload(path, file)
    if (upErr) { console.error('Upload error', upErr); return null }
    const { data } = supabase.storage.from(bucketName).getPublicUrl(path)
    return data?.publicUrl ?? null
  }

  function parseNum(v) {
    if (v === '' || v === null || v === undefined) return null
    const n = Number(v)
    return Number.isFinite(n) ? n : null
  }

  // Submit
  async function submitReport(e) {
    e.preventDefault()
    const issue = document.getElementById('issue').value.trim()
    const desc = document.getElementById('desc').value.trim()
    const location_text = document.getElementById('location_text').value.trim()
    const lat = parseNum(document.getElementById('latitude').value)
    const lng = parseNum(document.getElementById('longitude').value)
    const photoFile = document.getElementById('photo').files

    if (!issue || !desc || !location_text) { alert('Please fill issue, description and address'); return }
    if (lat !== null && (lat < -90 || lat > 90)) { alert('Latitude must be between -90 and 90'); return }
    if (lng !== null && (lng < -180 || lng > 180)) { alert('Longitude must be between -180 and 180'); return }

    let image_url = null
    if (photoFile) image_url = await uploadImage(photoFile)

    const { error } = await supabase.from('complaints').insert([{
      issue_type: issue,
      description: desc,
      image_url,
      location_text,
      latitude: lat,
      longitude: lng,
      created_at: new Date().toISOString()
    }])
    if (error) { alert('❌ Failed: ' + error.message); return }
    alert('✅ Complaint submitted!'); window.location.href = 'home.html'
  }

  document.getElementById('reportForm').addEventListener('submit', submitReport)
</script>
