<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Report Issue - CivicRevolution</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    body { margin:0; font-family:"Segoe UI",sans-serif; background:#f3f4f6; display:flex; align-items:center; justify-content:center; min-height:100vh; padding:2rem; }
    .report-box { background:#fff; padding:2.5rem; border-radius:20px; width:100%; max-width:650px; min-height:70vh; box-shadow:0 8px 24px rgba(0,0,0,0.1); display:flex; flex-direction:column; }
    h1 { text-align:center; color:#1d4ed8; margin-bottom:2rem; font-size:2rem; }
    label { font-weight:600; margin-bottom:0.5rem; display:block; color:#374151; }
    select,input,textarea { width:100%; padding:0.9rem; margin-bottom:1.5rem; border:1px solid #d1d5db; border-radius:12px; font-size:1rem; background:#f9fafb; }
    textarea { resize:vertical; min-height:120px; }
    button { width:100%; padding:1rem; background:#3b82f6; color:#fff; border:none; border-radius:12px; font-size:1.1rem; font-weight:600; cursor:pointer; margin-top:0.5rem; }
    button:hover { background:#1d4ed8; }
    #map { width:100%; height:300px; margin-bottom:1.5rem; border-radius:12px; overflow:hidden; }
    .loc-btn { width:100%; padding:1rem; background:#10b981; color:#fff; border:none; border-radius:12px; font-size:1.1rem; font-weight:600; cursor:pointer; margin-bottom:1rem; }
    .loc-btn:hover { background:#059669; }
  </style>
</head>
<body>
  <div class="report-box">
    <h1>Report an Issue</h1>
    <form id="reportForm">
      <label for="issue">Issue Type</label>
      <select id="issue" required>
        <option value="">-- Select --</option>
        <option>Pothole</option><option>Garbage</option><option>Street Light</option><option>Water Leakage</option><option>Other</option>
      </select>

      <label for="desc">Description</label>
      <textarea id="desc" placeholder="Explain the issue..." required></textarea>

      <label for="photo">Upload Photo</label>
      <input type="file" id="photo" accept="image/*" />

      <label for="location_text">Address or landmark</label>
      <input type="text" id="location_text" placeholder="Enter location or landmark" required />

      <label>Coordinates (click map or use button)</label>
      <button type="button" class="loc-btn" id="useLocBtn">üìç Use My Location</button>
      <div id="map"></div>
      <input type="number" id="latitude" step="any" placeholder="Latitude e.g. 19.0760" />
      <input type="number" id="longitude" step="any" placeholder="Longitude e.g. 72.8777" />

      <button type="submit">üì© Submit Report</button>
    </form>
    <div class="back-btn"><a href="home.html">‚¨Ö Back to Home</a></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const SUPABASE_URL = 'https://xnqtjcovuqzajuqzaunf.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhucXRqY292dXF6YWp1cXphdW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MzIyMzEsImV4cCI6MjA3MzEwODIzMX0.YbmzZoqOdIX_inX-khtpg1IsiCNUROAvR4Z2N85lEvM'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const bucketName = 'Complaint-Images'

    // Leaflet map
    let map, marker
    function initMap() {
      map = L.map('map').setView([18.5204, 73.8567], 12)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map)
      map.on('click', (e) => {
        const lat = e.latlng.lat
        const lng = e.latlng.lng
        document.getElementById('latitude').value = lat
        document.getElementById('longitude').value = lng
        if (marker) map.removeLayer(marker)
        marker = L.marker([lat, lng]).addTo(map)
      })
    }
    window.addEventListener('load', initMap)

    // Geolocation
    document.getElementById('useLocBtn').onclick = function() {
      if (!navigator.geolocation) { alert('Geolocation not supported'); return }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude
          const lng = pos.coords.longitude
          document.getElementById('latitude').value = lat
          document.getElementById('longitude').value = lng
          map.setView([lat, lng], 15)
          if (marker) map.removeLayer(marker)
          marker = L.marker([lat, lng]).addTo(map)
        },
        (err) => alert('Location error: ' + err.message)
      )
    }

    // Upload image
    async function uploadImage(file) {
      if (!file) return null
      const ext = file.name.split('.').pop()
      const path = ${Date.now()}.${ext}
      const { error } = await supabase.storage.from(bucketName).upload(path, file)
      if (error) { console.error('Upload error', error); return null }
      const { data } = supabase.storage.from(bucketName).getPublicUrl(path)
      return data?.publicUrl ?? null
    }

    function parseNum(v){ if(v===null||v===undefined||v==='') return null; const n=Number(v); return Number.isFinite(n)?n:null }

    // Submit
    async function submitReport(e){
      e.preventDefault()
      const issue = document.getElementById('issue').value.trim()
      const desc = document.getElementById('desc').value.trim()
      const location_text = document.getElementById('location_text').value.trim()
      const lat = parseNum(document.getElementById('latitude').value)
      const lng = parseNum(document.getElementById('longitude').value)
      const photoFile = document.getElementById('photo').files

      if (!issue || !desc || !location_text) { alert('Please fill issue, description and address'); return }
      if (lat !== null && (lat < -90 || lat > 90)) { alert('Latitude must be between -90 and 90'); return }
      if (lng !== null && (lng < -180 || lng > 180)) { alert('Longitude must be between -180 and 180'); return }

      let image_url = null
      if (photoFile) image_url = await uploadImage(photoFile)

      const { error } = await supabase.from('complaints').insert([{
        issue_type: issue,
        description: desc,
        image_url,
        location_text,
        latitude: lat,
        longitude: lng,
        created_at: new Date().toISOString()
      }])
      if (error) { alert('‚ùå Failed: ' + error.message); return }
      alert('‚úÖ Complaint submitted!'); window.location.href = 'home.html'
    }

    document.getElementById('reportForm').addEventListener('submit', submitReport)
  </script>
</body>
</html>
